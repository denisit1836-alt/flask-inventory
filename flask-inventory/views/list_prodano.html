<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет продаж</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='tables-style.css') }}">
</head>
<body>
    <div class="container">
        <a href="{{ url_for('index') }}" class="button-back">Назад</a>

        <h1 style="text-align: center;">Учет продаж</h1>

        <!-- Форма добавления -->
        <div class="form-add">
            <h2>Добавить запись о продаже</h2>
            <form method="POST" action="{{ url_for('prodano.create_prodano') }}" autocomplete="off">
                <div class="form-row">
                    <label>Товар:</label>
                    <select name="tovar_name" class="tovar-select text-field" required>
                        <option value="">— Выберите товар —</option>
                        {% for tovar in tovars %}
                            <option value="{{ tovar.name }}" data-cost="{{ tovar.cost }}">
                                {{ tovar.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <label>Услуга:</label>
                    <select name="usluga_name" class="usluga-select text-field">
                        <option value="" data-cost="0">— Без услуги —</option>
                        {% for usluga in uslugi %}
                            <option value="{{ usluga.name }}" data-cost="{{ usluga.cost }}">
                                {{ usluga.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <label>Продавец:</label>
                    <input type="text" name="personal" required class="text-field">
                </div>

                <div class="form-row">
                    <label>Стоимость (товар + услуга):</label>
                    <input type="text" id="total-cost-add" class="text-field" readonly value="0">
                </div>

                <div class="form-row">
                    <label>Дата продажи:</label>
                    <input type="date" name="date" required class="text-field">
                </div>

                <div class="form-row" style="justify-content: center; margin-top: 20px;">
                    <button type="submit" class="button-add">Добавить</button>
                </div>
            </form>
        </div>

        <hr>

        <!-- Таблица продаж -->
        <h2>Продажи</h2>
        <table class="all-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Товар</th>
                    <th>Услуга</th>
                    <th>Продавец</th>
                    <th>Стоимость</th>
                    <th>Дата продажи</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <form method="POST" action="{{ url_for('prodano.update_prodano', item_id=item.id) }}">
                        <td style="text-align: center;">
                            <input type="text" name="id" value="{{ item.id }}" disabled class="text-field" style="width: 50px;">
                        </td>

                        <td>
                            <select name="tovar_name" class="tovar-select text-field">
                                {% for tovar in tovars %}
                                    <option value="{{ tovar.name }}" data-cost="{{ tovar.cost }}"
                                        {% if tovar.name == item.name %}selected{% endif %}>
                                        {{ tovar.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>

                        <td>
                            <select name="usluga_name" class="usluga-select text-field">
                                <option value="" data-cost="0">— Без услуги —</option>
                                {% for usluga in uslugi %}
                                    <option value="{{ usluga.name }}" data-cost="{{ usluga.cost }}"
                                        {% if usluga.name == item.usluga_name %}selected{% endif %}>
                                        {{ usluga.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>

                        <td><input type="text" name="personal" value="{{ item.personal }}" class="text-field"></td>

                        <td>
                            <input type="text" class="total-cost text-field" value="{{ item.cost }}" readonly>
                        </td>

                        <td><input type="date" name="date" value="{{ item.date }}" class="text-field"></td>

                        <td style="text-align: center; white-space: nowrap;">
                            <button type="submit" class="button-redact">Изменить</button>
                            <button type="submit" formaction="{{ url_for('prodano.delete_prodano', item_id=item.id) }}" class="button-delete">Удалить</button>
                        </td>
                    </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Надёжный JavaScript — работает всегда -->
    <script>
        function calculateTotal() {
            const tovarSelect = document.querySelector('.tovar-select');
            const uslugaSelect = document.querySelector('.usluga-select');
            const totalInput = document.getElementById('total-cost-add');

            const tovarCost = parseFloat(tovarSelect?.selectedOptions[0]?.dataset.cost || 0);
            const uslugaCost = parseFloat(uslugaSelect?.selectedOptions[0]?.dataset.cost || 0);

            totalInput.value = (tovarCost + uslugaCost).toFixed(2);
        }

        function calculateRowTotal(row) {
            const tovarSelect = row.querySelector('.tovar-select');
            const uslugaSelect = row.querySelector('.usluga-select');
            const totalInput = row.querySelector('.total-cost');

            const tovarCost = parseFloat(tovarSelect?.selectedOptions[0]?.dataset.cost || 0);
            const uslugaCost = parseFloat(uslugaSelect?.selectedOptions[0]?.dataset.cost || 0);

            totalInput.value = (tovarCost + uslugaCost).toFixed(2);
        }

        // При изменении любого select — пересчитываем
        document.addEventListener('change', function(e) {
            if (e.target.matches('.tovar-select') || e.target.matches('.usluga-select')) {
                const row = e.target.closest('tr') || document;
                if (row === document) {
                    calculateTotal();
                } else {
                    calculateRowTotal(row);
                }
            }
        });

        // При загрузке страницы — рассчитываем все суммы
        document.addEventListener('DOMContentLoaded', function() {
            calculateTotal();
            document.querySelectorAll('tbody tr').forEach(row => calculateRowTotal(row));
        });
    </script>
</body>
</html>